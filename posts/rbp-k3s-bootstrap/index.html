<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.79.1" />

    
    
    

<title>RPi K3s • My Tech Notes</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RPi K3s"/>
<meta name="twitter:description" content="Back with the RPis Last time I was playing with the Raspberry Pi I used ansible to configure docker and some services on it. I still wasn&rsquo;t happy with the solution: my RPi 2 was really slow to run the Ansible configuration and the setup couldn&rsquo;t really recover from any errors without manual intervention."/>

<meta property="og:title" content="RPi K3s" />
<meta property="og:description" content="Back with the RPis Last time I was playing with the Raspberry Pi I used ansible to configure docker and some services on it. I still wasn&rsquo;t happy with the solution: my RPi 2 was really slow to run the Ansible configuration and the setup couldn&rsquo;t really recover from any errors without manual intervention." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thsp.dev/posts/rbp-k3s-bootstrap/" />
<meta property="article:published_time" content="2020-11-20T08:40:49-03:00" />
<meta property="article:modified_time" content="2020-11-20T08:40:49-03:00" /><meta property="og:site_name" content="Thiago&#39;s Tech Notes" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.71157e768c4e111a23c3531b95e0cbb59bbef3c9e6901d36247cb53d6b6be258.css" integrity="sha256-cRV&#43;doxOERojw1MbleDLtZu&#43;88nmkB02JHy1PWtr4lg=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://thsp.dev/">
        
          My Tech Notes
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://thsp.dev/avatar.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Don&#39;t forget your towel 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">My Tech Notes</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/thspinto" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://github.com/thspinto" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/thspinto" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 - 2020 htr3n
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>RPi K3s</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020-11-20
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/ansible">ansible</a>
           
      
          <a class="badge badge-tag" href="/tags/rbp">rbp</a>
           
      
          <a class="badge badge-tag" href="/tags/rbi">rbi</a>
           
      
          <a class="badge badge-tag" href="/tags/raspberry">raspberry</a>
           
      
          <a class="badge badge-tag" href="/tags/k3s">k3s</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  
  
  <div class="post">
    <p><img src="/k3s.png" alt="K3s logo"></p>
<h1 id="back-with-the-rpis">Back with the RPis</h1>
<p>Last time I was playing with the Raspberry Pi I used ansible to configure docker and some services on it. I still wasn&rsquo;t happy with the solution: my RPi 2 was really slow to run the Ansible configuration and the setup couldn&rsquo;t really recover from any errors without manual intervention.</p>
<p>Now I&rsquo;ve upgraded my hardware and certainly over complicated the software for a small home server, but now I got metrics =).</p>
<h1 id="hardware">Hardware</h1>
<p>Since I use Kubernetes on a daily basis I decided to upgrade my home setup to a k3s cluster. I&rsquo;ve started with 3 nodes:</p>
<ul>
<li>RPi 2 model B</li>
<li>RPi 3</li>
<li>RPi 4 4GB ram</li>
</ul>
<p>I added &ldquo;so much&rdquo; hardware because my objective is to actively monitor the cluster using Prometheus and Grafana.</p>
<p>The oldest node <code>RPi 2 model B</code> got decommissioned in the process. It wasn&rsquo;t consistent and had issues joining the cluster. He&rsquo;ll probably turn in to a weather station. I replaced it with RPi 4 to run the cluster with HA etcd. In the latest configuration all 3 nodes are master nodes and compose an cluster for K3s to use.</p>
<h1 id="os-bootstrapping">OS bootstrapping</h1>
<p>This first problem I didn&rsquo;t want to deal manually was configuring the ssh on the RPis. The previous process I had one playbook to configure the ssh and user on Raspberian, and another to configured everything else. This time, though, the node will boot with password login disabled and with my public keys automatically added to the host. To achieve this I used <a href="https://github.com/nmcclain/raspberian-firstboot">Raspberian Firstboot</a> with a <a href="https://github.com/thspinto/rpi-cluster/tree/main/os_bootstrap">custom script</a> to setup the ssh configuration and hostname.</p>
<p>All I have to do now I burn the Rapberian Firstboot image to the SD card and put the <code>firstboot.sh</code> and <code>bootstrap.env</code> in the <code>boot</code> dir. After the node boots up we can proceed directly to the Ansible configuration.</p>
<h1 id="ansible">Ansible</h1>
<p>Ansible is responsible for the initial setup of the nodes. The playbook optimizes the RPi to run headless, configures k3s and my local kubectl context with the new cluster. Since all k3s resources are managed by ArgoCD ansible also installs it in the cluster.</p>
<p><img src="/spiderman-meme.jpg" alt="Meme of spiderman pointing to another spiderman"></p>
<p>After the initial ArgoCD installation Argo manages itself.</p>
<h1 id="argocd">ArgoCD</h1>
<p>Why ArgoCD for such a small setup?</p>
<p><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR9es8OrAdRShum4eHs9WViIt72A05MZvQ30g&amp;usqp=CAU" alt="Meme - Strong dog: &ldquo;computers then: I sent people to the moon with just 4kb ram. Crying normal dog: &ldquo;computers now: help me please 4Gb ram is not enough for me."></p>
<p>On the previous setup I had to expose the ssh service on the internet to play with the cluster outside the lan. I also had to run Ansible every time I modified the services. Because my RPi was slow it really boring to wait several minutes for simple modifications. Now with GitOps on ArgoCD I don&rsquo;t need direct access to the nodes to configure the services.</p>
<p>There was a risk that I would exhaust the cluster resources with only the maintenance services, but there are still around 60% free resources after adding:</p>
<ul>
<li>ArgoCD</li>
<li>Prometheus</li>
<li>Grafana</li>
<li>External DNS</li>
<li>Cert-Manager</li>
<li>Kong</li>
</ul>
<h2 id="argocd-project-and-application-bootstrapping">ArgoCD project and application bootstrapping</h2>
<p>To bootstrap the argo configuration I used the <a href="https://argoproj.github.io/argo-cd/operator-manual/cluster-bootstrapping/">app of apps</a> pattern. This is Ansible&rsquo;s responsibility: it applies to k3s <a href="https://github.com/thspinto/rpi-cluster/tree/main/argocd/bootstrap">3 initial configurations</a>. Service applications and infrastructure applications are separated to give less permissions to non infrastructure service configuration. The other configuration is to bootstrap argo projects to create new ones directly from argo in case we need it.</p>
<h2 id="secrets">Secrets</h2>
<p>My first approach to keep secrets versioned was using <a href="https://github.com/bitnami-labs/sealed-secrets">Sealed Secrets</a>. Since I don&rsquo;t care about backups yet and rebuild the cluster frequently for testing, I had to recreate the sealed secrets every time I destroyed the cluster because I lost the encryption keys. I found it a lot easier to just keep an encrypted <code>secrets.yaml</code> file in the repository. In this workflow, every time I spin up a new cluster, I just have o decrypt the file and apply it to the new cluster.
Although it is encrypted I don&rsquo;t really recommend keeping the file in a public github repository. I&rsquo;m doing this to not loose the secrets util I workout a better flow for personal projects.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/my-rbp-setup/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">My Raspberry Pi Setup</span>
    </a>
    
    
</div>


  


<div class="post__related">
    
    <h2>Related Articles</h2>
    <ul class="related-posts">
        
<li>
  <span class="list__title--small">
    <a href="/posts/my-rbp-setup/" >My Raspberry Pi Setup</a>
      
      <time class="pull-right hidden-tablet">2020-03-08</time>
      
  </span>
</li>


    </ul>
</div>



  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'thsp-dev';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-160020317-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
