<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.79.1" />

    
    
    

<title>Esp8266 Adventures • My Tech Notes</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Esp8266 Adventures"/>
<meta name="twitter:description" content="ESP8266 Adventures How could technology help me in future impacted by global warming? This is a question that has been following me the past decade, specially where can my current area of study help me in this future."/>

<meta property="og:title" content="Esp8266 Adventures" />
<meta property="og:description" content="ESP8266 Adventures How could technology help me in future impacted by global warming? This is a question that has been following me the past decade, specially where can my current area of study help me in this future." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thsp.dev/posts/esp-adventures/" />
<meta property="article:published_time" content="2020-01-02T23:00:49-03:00" />
<meta property="article:modified_time" content="2020-01-02T23:00:49-03:00" /><meta property="og:site_name" content="Thiago&#39;s Tech Notes" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.71157e768c4e111a23c3531b95e0cbb59bbef3c9e6901d36247cb53d6b6be258.css" integrity="sha256-cRV&#43;doxOERojw1MbleDLtZu&#43;88nmkB02JHy1PWtr4lg=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://thsp.dev/">
        
          My Tech Notes
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://thsp.dev/avatar.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Don&#39;t forget your towel 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">My Tech Notes</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/thspinto" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://github.com/thspinto" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/thspinto" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 - 2021 htr3n
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Esp8266 Adventures</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020-01-02
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/esp8266">esp8266</a>
           
      
          <a class="badge badge-tag" href="/tags/arduino">arduino</a>
           
      
          <a class="badge badge-tag" href="/tags/mqtt">mqtt</a>
           
      
          <a class="badge badge-tag" href="/tags/k3s">k3s</a>
           
      
          <a class="badge badge-tag" href="/tags/prometheus">prometheus</a>
           
      
          <a class="badge badge-tag" href="/tags/grafana">grafana</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  
  
  <div class="post">
    <p><img src="/esp8266.png" alt="ESP8266 photo"></p>
<h1 id="esp8266-adventures">ESP8266 Adventures</h1>
<p>How could technology help me in future impacted by global warming? This is a question that has been following me the past decade, specially where can my current area of study help me in this future. I imagine that all our accumulated knowledge from tradition and science will be needed in order  to navigate through a new era of scarcity. My main area of study is in Computer Science and I&rsquo;ve mostly had contact with intangible stuff. This is were I set sail in my vacation: exploring were I can touch the tangible with the intangible.</p>
<p>Giving the scarcity scenario I thought that the most basic gadget I could build to learn for the future is a simple weather station. You need light, healthy soil and the right amount of water to grow food.</p>
<p>My idea was just collecting the temperature, air humidity, soil humidity and sending it to my cluster for processing. For that I needed some type of wireless connection. So I went online and bought the most simple looking and cheep module I cloud find to couple it to and Arduino I&rsquo;ve already owned. I got the ESP-12e and that is were a hole new world opened beneath my feet and thing got a little more complicated.</p>
<h2 id="programming-the-esp8266">Programming the ESP8266</h2>
<p>What I didn&rsquo;t know is that the ESP8266 is not just a Wifi module, it can be programmed and even run a web server inside. Of course there was a community leveraging this for IOT, and they led me to <a href="https://docs.openmqttgateway.com/">OpenMQTTGateway</a>. This project collects various signals and sensor from IOT devices and sends it to a queue to be used by HomeAutomation services such as <a href="https://www.home-assistant.io/">Home Assistant</a>. Given my astonishment of the capacity of this module of course I didn&rsquo;t have any tools that would make my life easier in programming it.</p>
<p>Since I had an Arduino I thought it would be easy to use it to program the ESP. My first blocker is that I saw on a tutorial that I needed an external 3,3V power source because Arduino&rsquo;s 3,3V output didn&rsquo;t have enough current for the module. I found 3 used 1,5V batteries that connected in series gave me 3,6V. The datasheet says that 3,6V is within the operational voltage, so achievement unlocked for recycling used batteries. (I do have to notice that I found out later that used batteries are really bad at keeping the voltage I measured without any usage.)</p>
<p>Now I just had to flash the OpenMQTTGateway project into the module. Well, to put it into flash mode you have to reboot the module with the GPIO0. I found this nice schematics in instructables:</p>
<p><img src="/arduino_schematics.png" alt="Image showing how to connect Arduino to flash an ESP8266 module">
<a href="https://www.instructables.com/ESP-12E-ESP8266-With-Arduino-Uno-Getting-Connected/">https://www.instructables.com/ESP-12E-ESP8266-With-Arduino-Uno-Getting-Connected/</a></p>
<p>My execution of it was a disaster because I bought the wrong pin bar (the ESP-12E has a smaller distance between the roles in comparison to the default protoboard) so I just attached the wires directly to the module. Of course that doing so made it very unstable and I couldn&rsquo;t breath near it without triggering a reset. But it I got it be be stable enough to flash it. The next issue I had was not flowing correctly the instructions: I was trying to use Arduino IDE to program the module and it wasn&rsquo;t able to connect. First of all it is very important to connect the ground to reset in the Arduino board. Apparently when you open the usb-to-serial converter Arduino automatically resets and keeping reset pin to ground avoids that.</p>
<h1 id="pin-info">Pin info</h1>
<p><img src="/esp8266_pins.png" alt="Image showing the ESP8266 pin and their usage."></p>
<p>⚠️ To flash software to the module no other sensor can be attached.</p>
<p><img src="https://circuits4you.com/wp-content/uploads/2016/12/ESP-12-PinOut.png" alt="Image showing where the pins are located in the ESP 8266."></p>
<p>I ended buying a fiber glass protoboard to weld everything together and make the setup more stable (I admit I do have practice welding to get more motor coordination). Finally I also added a USB cable and a tension regulator to 3,3V for constant power supply.</p>
<p><img src="/final_esp_setup.jpg" alt="Image of the welded final setup of my ESP with a tension regulator and the DHT sensor."></p>
<p>You might ask me why didn&rsquo;t you just buy the <a href="https://www.nodemcu.com/">nodemcu</a>? Well, I basically didn&rsquo;t know of its existence and I never thought that &ldquo;wifi module&rdquo; could do so much. It was fun to learn, but it is certainly better to buy the nodemcu because it is pretty cheap (even in Brazil) and flashing it and connecting stuff to it is a lot simpler.</p>
<h2 id="openmqttgateway-configuration">OpenMQTTGateway Configuration</h2>
<p>To manually configure the network and MQTT I added the following to <a href="https://github.com/1technophile/OpenMQTTGateway/blob/development/main/User_config.h">User_config.h</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define ESPWifiManualSetup true
</span><span style="color:#75715e">#define MQTT_SERVER &#34;your.server&#34;
</span><span style="color:#75715e">#define MQTT_USER &#34;user&#34;
</span><span style="color:#75715e">#define MQTT_PASS &#34;pass&#34;
</span><span style="color:#75715e">#define wifi_ssid &#34;ssid&#34;
</span><span style="color:#75715e">#define wifi_password &#34;pass&#34;
</span><span style="color:#75715e">#define SECURE_CONNECTION
</span><span style="color:#75715e">#define MQTT_PORT &#34;9443&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> certificate CERT_ATTRIBUTE <span style="color:#f92672">=</span> R<span style="color:#e6db74">&#34;EOF(&#34;</span>
<span style="color:#f92672">-----</span>BEGIN CERTIFICATE<span style="color:#f92672">-----</span>
... <span style="color:#75715e">// your root certificate: see here for let`s encypt https://letsencrypt.org/certificates/
</span><span style="color:#75715e"></span><span style="color:#f92672">-----</span>END CERTIFICATE<span style="color:#f92672">-----</span>
<span style="color:#e6db74">&#34;)EOF&#34;</span>;
</code></pre></div><h2 id="collecting-the-metrics">Collecting the metrics</h2>
<p>To collect and view the sensor data I&rsquo;m using Mosquitto, Prometheus and Grafana. For Prometheus to be able to collect the data I&rsquo;m running <a href="https://github.com/kpetremann/mqtt-exporter">an exporter</a> that reads the data from the queue and provides a http endpoint in the format Prometheus expects.</p>
<p><img src="/esp_home.png" alt="Diagram showing the the flow where the data is collected, sent do MQTT. Moquitto exported read the queue and exposes the data to Prometheus and Grafana queries Prometheus and renders the dasboard."></p>
<p><img src="/grafana.png" alt="Dashboard showing the metrics temperature and humidity, collected by the sensor conected to the ESP8266."></p>
<h2 id="references">References</h2>
<p><a href="https://docs.openmqttgateway.com/">🔗 OpenMQTTGateway</a></p>
<p><a href="https://www.espressif.com/sites/default/files/documentation/4a-esp8266_at_instruction_set_en.pdf">🔗 AT instruction set</a></p>

  </div>
  

<div class="navigation navigation-single">
    
    
    <a href="/posts/my-rbp-setup/" class="navigation-next">
      <span class="navigation-tittle">My Raspberry Pi Setup</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  




  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'thsp-dev';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-160020317-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
